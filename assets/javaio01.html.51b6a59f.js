import{_ as c,V as u,W as i,Y as n,Z as s,$ as a,a0 as e,x as o}from"./framework.3bd681ae.js";const l={},r=e('<h1 id="关于i-o操作乱码问题" tabindex="-1"><a class="header-anchor" href="#关于i-o操作乱码问题" aria-hidden="true">#</a> 关于I/O操作乱码问题</h1><h2 id="为啥需要编码" tabindex="-1"><a class="header-anchor" href="#为啥需要编码" aria-hidden="true">#</a> 为啥需要编码</h2><p>计算机无法识别我们人类语言，为了能够让计算机识别我们人类语言就采用了某种符号来表示，但是我们人类的语言太多了，表示这些语言的符号也很多，且不能完全用一个字节来表示，所以就必须进行拆分或一些翻译的工作才能让计算机识别我们人类的语言，而这种拆分或翻译的过程我们就称为编码</p><p>我们都知道，计算机的 1byte = 8bit ，其可以表示的符号是0~255个，如果用这些符号来表示英文字符是完全足够了，但是因为人类的语言太多了，无法完全用一个byte来表示，比如中文，因此就有了一种新的数据结构char，从char到byte必须编码</p><p>上面我们讲了让计算机识别我们人类的语言，通过某种符号来表示，但对于这些符号计算机又是如何来翻译成我们人类的语言的呢</p><p>计算机提供了多种翻译方式，比如ASCII、ISO-8859-1、GB2313、GBK、UTF-8等，这些我们统称为编码格式，可以把它们看作是字典，它们规定了转化规则，按照这个规则就可以让计算机正确的表示我们的字符 编码格式有很多种，就目前来看一共有七种主要得编码格式，它们之间的编码效率以及编码结构都各有不同</p><h2 id="七种编码格式" tabindex="-1"><a class="header-anchor" href="#七种编码格式" aria-hidden="true">#</a> 七种编码格式</h2><h3 id="ascii码" tabindex="-1"><a class="header-anchor" href="#ascii码" aria-hidden="true">#</a> ASCII码</h3><p>ASCII码一共有128个，用1个字节的低7位表示，0 ~ 31是控制字符如换行、删除等，32 ~ 126是打印字符，可以通过键盘输入并且能够显示出来，下图是ASCII码表</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f46a7ad269d4a2cb9f7fa77c34fea86~tplv-k3u1fbpfcp-zoom-1.image" alt="ascii.jpeg"></p><h3 id="iso-8859-1" tabindex="-1"><a class="header-anchor" href="#iso-8859-1" aria-hidden="true">#</a> ISO-8859-1</h3>',11),k={href:"https://www.haomeili.net/Code/ASCII?key=iso-8859-1",target:"_blank",rel:"noopener noreferrer"},d=n("h3",{id:"gb2312",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#gb2312","aria-hidden":"true"},"#"),s(" GB2312")],-1),m=n("p",null,"GB23121的全称是《信息技术中文编码字符集》，它是双字节编码，总的编码范围是A1~F7，其中A1~A9是符号区，总共包含682个符号；B0~F7是汉字区，包含6763个汉字",-1),v={href:"https://www.toolhelper.cn/Encoding/GB2312",target:"_blank",rel:"noopener noreferrer"},b=n("h3",{id:"gbk",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#gbk","aria-hidden":"true"},"#"),s(" GBK")],-1),h=n("p",null,"GBK全称是《汉字内码扩展规范》，它的出现是为了扩展GB2312，并加入更多的汉字。它的编码范围是8140~FEFE(去掉XX7F)，总共有23940个码位，他能表示21003个汉字，它的编码是和GB2312兼容的，也就是说用GB2312编码的汉字可以用GBK来解码，并且不会乱码",-1),g={href:"https://www.toolhelper.cn/Encoding/GBK",target:"_blank",rel:"noopener noreferrer"},f=n("h3",{id:"gb18030",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#gb18030","aria-hidden":"true"},"#"),s(" GB18030")],-1),y=n("p",null,"GB18030全称是《信息技术中文编码字符集》，它可能是单字节、双字节或者四字节编码，它的编码与GB2312编码兼容，但是这种编码格式在实际应用使用得并不广泛",-1),w=n("h3",{id:"utf-16",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#utf-16","aria-hidden":"true"},"#"),s(" UTF-16")],-1),I=n("p",null,"说到UTF必须提到Unicode(Universal Code 统一码)，我们也称为万国码，世界上所有的语言都可以通过这个码表来翻译",-1),T={href:"https://www.cnblogs.com/csguo/p/7401874.html",target:"_blank",rel:"noopener noreferrer"},S=e(`<p>而UTF-16具体定义了Unicode字符在计算机中的存取方法，UTF-16用两个字节来表示Unicode的转化格式，它采用定长的表示方法，即不论什么字符都可以用两个字节表示，因为两个自己是16位，所以叫UTF-16。UTF-16表示字符非常的方便，每两个字节表示一个字符，这极大的简化了字符串的操作，这也是Java以UTF-16作为内存的字符存储格式的一个原因</p><h3 id="utf-8" tabindex="-1"><a class="header-anchor" href="#utf-8" aria-hidden="true">#</a> UTF-8</h3><p>UTF-16虽然表示字符非常的方便，但是有些时候本来用一个字节就可以表示的字符，UTF-16也用了了两个字节表示，这无形中将存储空间扩大了一倍，这在网络间传输中也会增大网络传输的流量。</p><p>而UTF-8采用了一种变长技术，每个编码区域有不同的字码长度，也就是说不同的字符用不同的字节长度表示，这就减少了存储空间的占用</p><h2 id="i-o操作中存在的编码" tabindex="-1"><a class="header-anchor" href="#i-o操作中存在的编码" aria-hidden="true">#</a> I/O操作中存在的编码</h2><p>上面我们讲了编码存在于字节到字符(或字符到字节)之间的转换，那么这就涉及到我们具体的一些I/O操作，其中就包括磁盘I/O和网络I/O</p><h3 id="磁盘i-o存在的编码" tabindex="-1"><a class="header-anchor" href="#磁盘i-o存在的编码" aria-hidden="true">#</a> 磁盘I/O存在的编码</h3><p>我们在项目开发中经常会涉及到对于磁盘的I/O操作，Java给我们提供了对于磁盘的I/O操作类InputStream和OutputStream，其子类InputStramReader类就是负责在I/O过程中处理读取字节到字符之间的转换，对于字节到字符的编码实现，它又委托StreamDecoder去做，在StreamReader解码过程中必须由用户指定Charset编码格式，如果没有指定Charset编码格式，那么就会使用系统默认的字符集</p><p>这也就是为什么我们在对于本地文件中字符读取的时候会出现乱码的关键原因，所以我们在做I/O的操作过程中一定要指定编码格式</p><p>那么对于写也是同样的，从字符到字节通过OutputStreamWriter类来操作，具体的编码由StreamEncoder类负责</p><p>我们再来看下操作示例</p><p>我当前本地有个abc.txt文件，文件里有一行中文字符 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90830b4650254109b010cd09eaa2a912~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p><p>并且这个文件我设置的编码字符集是GB2312</p><p>下面我直接用两种编码方式来读取</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//  第一种直接用UTF-8来读取</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStreamReader</span> inputStreamReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\\\Users\\\\Domino\\\\Desktop\\\\abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">=</span> inputStreamReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8字符集 读取字符：&quot;</span><span class="token operator">+</span>stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 第二种 直接用GB2312来读取</span>
        <span class="token class-name">StringBuilder</span> stringBuilder2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStreamReader</span> inputStreamReader2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\\\Users\\\\Domino\\\\Desktop\\\\abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;GB2312&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buf2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count2 <span class="token operator">=</span> inputStreamReader2<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            stringBuilder2<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>buf2<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>count2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;GB2312字符集 读取字符：&quot;</span><span class="token operator">+</span>stringBuilder2<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一种毋庸置疑肯定是会乱码的，因为原字符以GB2312的编码方式，第二种就可以正常展示，下面是运行结果 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11694d60f88f46ce8f09108bfbd6648b~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p><p>同样对于写入操作</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">OutputStreamWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">&quot;C:\\\\Users\\\\Domino\\\\Desktop\\\\abc.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;好的的&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我往GB2312字符编码格式的文件里写入UTF-8的字符，这里写入操作肯定也是乱码的，我们可以看下结果</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/477e443af24443368da4b0b6ce3ec99e~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"></p><p>为了弄清楚乱码的原因，我们再具体来看下不同编码格式的编码结构</p><p>用这一样字符串为例，看不同的编码格式是如何进行存储的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;I am 刘同学&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> isoHex <span class="token operator">=</span> <span class="token class-name">HexUtil</span><span class="token punctuation">.</span><span class="token function">encodeHex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;ISO-8859-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>isoHex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gb2312Hex <span class="token operator">=</span> <span class="token class-name">HexUtil</span><span class="token punctuation">.</span><span class="token function">encodeHex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;GB2312&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gb2312Hex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gbkHex <span class="token operator">=</span> <span class="token class-name">HexUtil</span><span class="token punctuation">.</span><span class="token function">encodeHex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;GBK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>gbkHex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> utf16Hex <span class="token operator">=</span> <span class="token class-name">HexUtil</span><span class="token punctuation">.</span><span class="token function">encodeHex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-16&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>utf16Hex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> utf8Hex <span class="token operator">=</span> <span class="token class-name">HexUtil</span><span class="token punctuation">.</span><span class="token function">encodeHex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>utf8Hex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我将字符串的不同编码字符集以char数组来进行输出，我们再来看看将char数组转换成字节是怎样的</p><p><strong>ISO-8859-1编码：</strong><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64376fd76b224b8e87db62540932e6a1~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构.jpg"> 8个char字符经过ISO-8859-1编码转换成7个byte数组，ISO-8859-1是单字节编码，中文“刘同学”就被转换成了3f，3f也就是“?”字符，我们在写代码读取字符的时候经常会有中文变成“?”，也有可能是使用了ISO-8859-1</p><p><strong>GB2312编码：</strong><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1517cb77885a48bfb8eb2a199ffb7f76~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构.png"></p><p>GB2312对于中文字符的存储是采用双字节，前面的五个字符经过编码分别占用一个字节，后面三个中文字符分别需要占用两个字节</p><p>GB2312有一个从char到byte的码表，不同的字符编码就是从这个码表找到与每个字符对应的字符，然后拼接成byte数组</p><p><strong>GBK编码：</strong><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/863fc464e1c841148826336108af1d3d~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构.png"> GBK与GB2313的编码结构是一样的，它们的编码算法也是一样的，不同的是，它们的码表长度不一样，GBK包含的汉字字符更多，所以只要是经过GB2312编码的汉字都可以用GBK编码，反之不然</p><p><strong>UTF-16编码：</strong><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1187a58f7364326801e4d24109495a7~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构 (1).png"> UTF-16对应的每个编码都有两个字节构成，所以字节数组被扩大了1倍，单字节范围内的字节在高位补0变成两个字节，中文字符也变成两个字节，但是这种编码规则简单高效，在编码的时候不用考虑但双字节问题</p><p><strong>UTF-8编码：</strong><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f43af19b0de94837954f678c3a44d71f~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构 (2).png"> UTF-16虽然编码效率很高，但是对单字节范围内的字符也放大了1倍，这无疑是浪费了存储空间，另外UTF-16是采用顺序编码，不能对单个字符的编码值进行校验，如果中间的一个码值损坏，后面的所有码值都将受影响。而UTF-8不存在这些问题，UTF-8对单字节范围内的字符任然采用1个字节表示，对汉字采用3个字节表示</p><h3 id="网络i-o存在的编码" tabindex="-1"><a class="header-anchor" href="#网络i-o存在的编码" aria-hidden="true">#</a> 网络I/O存在的编码</h3><p>这里的网络I/O主要我们在使用网络接收和发送数据的时候，常常会出现乱码问题，那么在整个数据发送或接收的过程中到底哪里会出现编码问题呢</p><p>我们以一个用户发送HTTP请求到服务端为例，那么在整个请求到响应的过程中存在编码的地方是请求的URL、Cookie和POST表单参数，在服务端接收到请求的时候需要对其进行解码，服务端接在处理请求的时候可能还需要访问数据库里的数据、本地或网络中其他地方的文本文件，这些数据都可能存在编码问题，整个过程如下</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/474111e8f4b94464ac8081f1777e4fd4~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构 (3).png"> 我们来具体看下一次HTTP请求中各个地方所用到的编码</p><h4 id="url的编解码" tabindex="-1"><a class="header-anchor" href="#url的编解码" aria-hidden="true">#</a> URL的编解码</h4><p>用户提交一个URL，在这个URL中可能存在中文(这里暂时先不考虑POST表单参数)，因此需要用到编码，我们以一个这样的URL为例</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c4886756dbb4387b204d87232554a0d~tplv-k3u1fbpfcp-zoom-1.image" alt="字符集编码结构 (5).png"></p><p>这里URI和请求参数都出现了中文，因此浏览器会对其进行编码，我们使用Firefox浏览器来看看具体是怎么编码的</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b38d5a0abe4a417bac5d3052b6cd68bc~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png"> 浏览器将URI里的中文编码成了E5 88 98 E5 90 8C E5 AD A6，而请求参数里的中文编码成了E5 BC A0 E4 B8 89，根据编码规则可以判断，URI里的中文编码是UTF-8编码，请求参数里的编码是GBK编码，对于这些编码为什么要用%，这是因为RFC3986规范，它将非ACII字符按照某种编码格式编成16进制之后，会在16进制表示的字节前面加上%</p><p>我们再来看下Tomcat(这里是以Tomcat8.0为例)是如何对这个URI部分进行解码的</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">convertURI</span><span class="token punctuation">(</span><span class="token class-name">MessageBytes</span> uri<span class="token punctuation">,</span> <span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ByteChunk</span> bc <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">getByteChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> length <span class="token operator">=</span> bc<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CharChunk</span> cc <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">getCharChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//从 server.xml 文件里获取设置的对于URI解码的字符集，默认是UTF-8</span>
        <span class="token class-name">Charset</span> charset <span class="token operator">=</span> connector<span class="token punctuation">.</span><span class="token function">getURICharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">B2CConverter</span> conv <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURIConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conv <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 设置编码字符集</span>
            conv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B2CConverter</span><span class="token punctuation">(</span>charset<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setURIConverter</span><span class="token punctuation">(</span>conv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            conv<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
             <span class="token comment">// 对URI进行解析</span>
            conv<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>bc<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            uri<span class="token punctuation">.</span><span class="token function">setChars</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cc<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_BAD_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>具体解析的地方我用注释标注了</p><p>这里之所以是通过Connector对象去获取编码字符集，是因为Tomcat会将server.xml文件里的Connector解析成一个对象</p>`,44),U=n("p",null,"我们再来看下对于URL里的请求参数是怎么解码的，以GET方式HTTP请求的请求参数与以POST请求的请求参数都可以通过request.getPatameter获取参数值。对它们的解码是在request.getPatameter第一次被调用的时候进行的",-1),C=n("blockquote",null,[n("p",null,"Content-Type : charset=utf-8")],-1),B=e(`<p>所以我们在对于网络中的数据读取如果不想看到乱码的情况的话，我们可以利用好 URIEncoding 和 useBodyEncodingForURI 这两个参数</p><h4 id="http-header-的编解码" tabindex="-1"><a class="header-anchor" href="#http-header-的编解码" aria-hidden="true">#</a> HTTP Header 的编解码</h4><p>当客户端发起一个HTTP请求时，除了上面的URL外还可能会在Header中传递其他参数，如Cookie、redirectPath等，这些用户设置的值也可能存在编码问题，那么Tomcat又是怎么解决的呢</p><p>对于Header中的参数获取是通过request.getHeader方法获取的，而对于Header的编解码字符集我们无法进行设置，Tomcat会直接使用ISO-8859-1进行解码，因此我们在Header中最好不要添加非ASCII字符，否则的话肯定是会出现乱码问题</p><p>如果非要传递非ASCII字符，我们可以先将这些字符URLEncoder编码再添加到Header中，当要获取字符的时候再通过URLDecoder进行解码，这样就可以很好的解决乱码问题了</p><h4 id="post表单的编解码" tabindex="-1"><a class="header-anchor" href="#post表单的编解码" aria-hidden="true">#</a> POST表单的编解码</h4><p>POST表单提交的数据解码也是通过第一次调用request.getParameter发生的，与上面的请求参数获取不同的是，它是通过HTTP的BODY传递到服务端。当我们在页面上单击提交按钮时浏览器首先将根据ContentType的Charset编码格式对在表单中填入的参数进行编码，服务器同样也是用ContentType中的字符集进行解码，所以通过POST表单提交的参数只要设置好编码格式一般是不会出现乱码问题，当然我们也可以通过request.setCharacterEncoding来进行设置编码字符集</p><p>在上面说过不管是表单提交参数还是通过QueryParam来提交参数，服务端对其解码都是通过第一次调用request.getParameter发生的，这样做虽然会提升效率，但其实也会造成一个问题</p><p>我们平时在开发中不知道有没有碰到过这个问题，就是明明已经通过request.setCharacterEncoding设置了正确的编码字符集了，但当去获取参数的时候还是会造成乱码问题，好像失效了样</p><p>这个问题到这里其实很好解释了，可能是我们代码中在调用 request.setCharacterEncoding 之前已经第一次调用了 request.getParameter ，所以导致所有的参数都按照默认的字符集解码了，后面再通过 request.setCharacterEncoding 设置编码字符集然后再调用 request.getParameter 获取参数进行时候并不会再一次进行解码，当然就会造成这种失效的现象</p><p>在做这种网络请求在使用这种body的方式提交参数的时候最好还是通过ContentType指定编码字符集，为什么这么说呢，因为Tomcat在解析的过程会判断ContentType里有没有Charset参数，如果有的话那么解析参数的时候会根据指定的编码字符集来进行解码，下面是它的源码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getCharsetFromContentType</span><span class="token punctuation">(</span><span class="token class-name">String</span> contentType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>contentType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断ContentType中有没有 charset 参数</span>
        <span class="token keyword">int</span> start <span class="token operator">=</span> contentType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;charset=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果有的话就直接截取出指定的字符集</span>
        <span class="token class-name">String</span> encoding <span class="token operator">=</span> contentType<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>start <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> end <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            encoding <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        encoding <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>encoding<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            encoding <span class="token operator">=</span> encoding<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> encoding<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> encoding<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要的代码逻辑我用注释标明了下</p><p>另外，针对multipat/form-data类型的参数，也就是上传的文件编码，同样也使用ContentType定义的字符集编码。但是上传文件时用字节流的方式传输到服务器的本地来临时目录，这个过程并不涉及到字符编码，而真正编码是在讲文件内容添加到parameters中时，如果用这个不能编码，则将会使用默认编码ISO-8859-1来编码</p><h4 id="http-body的编解码" tabindex="-1"><a class="header-anchor" href="#http-body的编解码" aria-hidden="true">#</a> HTTP BODY的编解码</h4>`,15),x=n("p",null,[s("当请求响应给用户的时候，响应的内容将通过Response返回给客户端浏览器，这个过程要先经过编码，再到浏览器进行解码，编解码的字符集可以通过respone.setCharacterEncoding来设置，如果没有设置那么浏览器将根据HTML的"),n("meta",{"HTTP-equiv":"Content-Type",content:"text/html;charset=GBK"}),s(" 中的charset来解码，如果也没定义的话那么浏览器将使用默认的编码来解码")],-1);function q(_,O){const p=o("ExternalLinkIcon"),t=o("Connector");return u(),i("div",null,[r,n("p",null,[s("128个字符很显然是不够的，于是ISO组织就在ASCII码基础上对其进行了扩展，它们是ISO-8859-1至ISO-8859-15，其中ISO-8859-1涵盖了大多数的西欧语言字符，也是用单字节表示，它总共能表示256个字符 对于ISO-8859-1的对照码表可以参考这个网址： "),n("a",k,[s("https://www.haomeili.net/Code/ASCII?key=iso-8859-1"),a(p)])]),d,m,n("p",null,[s("对于GB2312的对照码表可以参考这个网址："),n("a",v,[s("https://www.toolhelper.cn/Encoding/GB2312"),a(p)])]),b,h,n("p",null,[s("对于GBK的对照码表可以参考这个网址："),n("a",g,[s("https://www.toolhelper.cn/Encoding/GBK"),a(p)])]),f,y,w,I,n("p",null,[s("对于Unicode的对照码表可以参考这个网址："),n("a",T,[s("https://www.cnblogs.com/csguo/p/7401874.html"),a(p)])]),S,n("p",null,[s("我们在配置Tomcat端口的时候会在server.xml里的"),a(t,{port:"8080"}),s(" 节点里配置，当然这个节点除了配置端口外，还可以配置用于对URI解码的字符集，如果不配置的话默认是直接用UTF-8进行解码，我们如果有要修改的要求话可以直接在节点里添加一个 URIEncoding 属性就行了---- "),a(t,{port:"8080",URIEncoding:"GBK"})]),U,n("p",null,[s('那何为"第一次被调用的时候进行解码的" 呢，我们都知道一个HTTP请求到服务端对于服务端的，服务端对于参数的获取有可能在多处地方会调用request.getPatameter，那当第一次调用request.getPatameter获取参数的时候，这个参数就已经被解码了，后面其他的调用就不会再一次进行解码。这里解码默认是用UTF-8 那这个请求参数的解码字符集要怎么去设置呢，这里要注意下，如果我们在 server.xml 文件里的 '),a(t),s(" 添加了URIEncoding属性的话，那么在给请求参数解码的时候也会用URIEncoding这个参数所指定的字符集")]),n("p",null,[s("除了使用URIEncoding属性之外，还可以通过在Header中的ContentType定义Charset，如果要使用这种方式的话那就必须在"),a(t),s('节点里添加 useBodyEncodingForURI="true" ----'),a(t,{port:"8080",useBodyEncodingForURI:"true"}),s(" ContentType具体定义规则如下：")]),C,n("p",null,[s("这里要注意下，如果在"),a(t),s('节点中添加了useBodyEncodingForURI="true" ，而在ContentType不指定具体的编码字符集的话，那么将会默认使用ISO-8859-1')]),B,x])}const F=c(l,[["render",q],["__file","javaio01.html.vue"]]);export{F as default};
